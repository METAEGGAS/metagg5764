<!doctype html><html lang="ar" dir="rtl"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"><meta name="theme-color" content="#000"><title>Trading Chart</title><style>*{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,Arial;background:#000;color:#fff;direction:rtl}button,input,select{font:inherit;border:0;outline:0}button{cursor:pointer}::-webkit-scrollbar{width:0;height:0}:root{--gg:#00c853;--psw:48px;--bg-primary:#000;--bg-secondary:#0d1117;--bg-card:#101a2f;--bg-overlay:rgba(10,22,40,.72);--border-primary:rgba(255,255,255,.10);--border-secondary:#1f2937;--text-primary:#fff;--text-secondary:#d9e6ff;--accent-green:#00ff41;--accent-red:#ff0000;--accent-blue:#4299e1}.chartWrap{position:fixed;inset:0;overflow:hidden;background:#000}#sk{position:absolute;inset:0;z-index:2500;pointer-events:auto;background:#000;display:none}#sk.on{display:block}#sk:before,#sk:after{content:"";position:absolute;inset:-40%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);filter:blur(2px);animation:sk 1.35s linear infinite}#sk:after{background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);animation-duration:1.75s;transform:rotate(90deg)}@keyframes sk{0%{transform:translateX(-40%) rotate(0)}100%{transform:translateX(40%) rotate(0)}}.chartFrame,.tc{position:absolute;inset:0;overflow:hidden;background:transparent}#c{display:block;position:absolute;inset:0;width:100%!important;height:100%!important;touch-action:none;cursor:grab}#c:active{cursor:grabbing}.ps{position:absolute;right:0;top:0;bottom:120px;width:var(--psw);pointer-events:none;background:rgba(0,0,0,.35);z-index:10}.pl{position:absolute;right:2px;transform:translateY(-50%);font-size:10px;font-weight:900;color:rgba(240,230,210,.92);text-align:right;padding:0 3px;text-shadow:0 1px 3px rgba(0,0,0,.6)}.priceIndicator{position:absolute;right:0;transform:translateY(-50%);background:rgba(255,215,0,.95);color:#000;padding:4px 8px;font-size:11px;font-weight:900;border-radius:4px 0 0 4px;z-index:100;box-shadow:0 2px 8px rgba(255,215,0,.4);border:1.5px solid #ffd700;border-right:none;pointer-events:none}.priceScaleMark{position:absolute;right:0;width:var(--psw);height:1px;background:rgba(255,215,0,.45);transform:translateY(-50%);z-index:11;pointer-events:none;box-shadow:0 0 6px rgba(255,215,0,.2)}.centerLine{position:absolute;left:50%;top:0;bottom:120px;width:1px;background:rgba(255,255,255,.2);pointer-events:none;z-index:5;transform:translateX(-50%)}.datetime{position:absolute;left:9px;bottom:130px;font-size:11px;color:var(--text-primary);background:var(--bg-overlay);padding:3px 8px;border-radius:7px;z-index:22;border:1px solid var(--border-primary);pointer-events:none}.platformTime{position:absolute;left:9px;top:10px;z-index:18;font-size:10px;color:rgba(255,255,255,.75);background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.08);padding:4px 8px;border-radius:8px;pointer-events:none}.indicatorIcons{position:absolute;left:9px;top:50px;z-index:22;display:flex;flex-direction:column;gap:8px}.indIcon{width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:rgba(250,240,220,.88);border:1.5px solid rgba(255,215,100,.7);border-radius:10px;cursor:pointer;transition:.2s;box-shadow:0 4px 12px rgba(0,0,0,.4)}.indIcon:hover{transform:scale(1.08);border-color:var(--accent-blue)}.indIcon img{width:28px;height:28px;object-fit:contain}.eyeIcon{width:22px;height:22px;display:none;align-items:center;justify-content:center;background:rgba(250,240,220,.88);border:1.5px solid rgba(255,215,100,.7);border-radius:8px;cursor:pointer;transition:.2s;box-shadow:0 4px 12px rgba(0,0,0,.4);font-size:13px}.eyeIcon:hover{transform:scale(1.08);border-color:var(--accent-blue)}.indNamesList{margin-top:4px;display:flex;flex-direction:column;gap:3px;align-items:center;justify-content:flex-start}.indNamesList .nmIt{min-width:18px;text-align:center;font-size:9px;font-weight:900;line-height:1.1;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.15);color:#fff;border-radius:5px;padding:3px 5px;backdrop-filter:blur(6px);cursor:pointer;transition:.2s}.indNamesList .nmIt:hover{background:rgba(66,153,225,.3);border-color:rgba(66,153,225,.6)}.indicatorsPanel{position:fixed;left:0;top:0;bottom:0;width:50%;max-width:400px;background:var(--bg-overlay);backdrop-filter:blur(10px);border-right:1.5px solid var(--border-primary);z-index:9998;transform:translateX(-100%);transition:transform .3s ease;padding:20px;overflow-y:auto;box-shadow:4px 0 24px rgba(0,0,0,.6)}.indicatorsPanel.show{transform:translateX(0)}.indPanelHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid var(--border-primary)}.indPanelHead h3{font-size:18px;color:var(--text-primary)}.closeIndBtn{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid var(--border-primary);font-size:24px;color:var(--text-secondary)}.indItem{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;margin-bottom:10px;background:rgba(255,255,255,.05);border:1px solid var(--border-primary);border-radius:10px;transition:.2s;cursor:pointer}.indItem:hover{background:rgba(255,255,255,.08)}.indItem span{font-size:14px;font-weight:900}.trading-controls{position:fixed;bottom:60px;left:0;right:0;padding:7px 9px;z-index:1000;background:var(--bg-primary)}.control-row{display:grid;grid-template-columns:1fr 1fr;gap:9px}.input-wrapper{display:flex;align-items:center;gap:4px;background:var(--bg-secondary);border:1px solid var(--border-secondary);border-radius:9px;padding:3px 7px;height:37px;position:relative}.input-field{background:0 0;color:var(--text-primary);font-size:14px;font-weight:900;text-align:center;flex:1;min-width:0;cursor:pointer}.ctrl-btn{background:0 0;color:var(--accent-blue);font-size:18px;padding:2px 6px;font-weight:1000}.timePickerPopup{position:absolute;bottom:100%;left:0;right:0;margin-bottom:4px;background:#000;border:1.5px solid var(--border-primary);border-radius:8px;padding:8px;z-index:9999;display:none;box-shadow:0 8px 24px rgba(0,0,0,.8)}.timePickerPopup.show{display:block}.timeGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:8px}.timeBtn{background:#2a3442;border:0;border-radius:6px;color:#fff;font-size:13px;font-weight:900;padding:10px;cursor:pointer;transition:.2s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.manualBtn{width:100%;background:#2a3442;border:0;border-radius:6px;color:#fff;font-size:13px;font-weight:900;padding:10px;cursor:pointer}.tradeDock{position:fixed;bottom:0;left:0;right:0;background:var(--bg-primary);padding:7px 0;z-index:1000}.trading-buttons{display:flex}.trade-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:7px;padding:11px 9px;font-size:15px;font-weight:1000;transition:transform .15s;height:48px}.trade-higher{background:linear-gradient(135deg,var(--accent-green) 0%,#00cc33 100%);color:var(--bg-primary);border-radius:0 11px 11px 0}.trade-lower{background:linear-gradient(135deg,var(--accent-red) 0%,#cc0000 100%);color:var(--text-primary);border-radius:11px 0 0 11px}.trade-higher:active,.trade-lower:active{transform:scale(.95)}.btn-icon{width:18px;height:18px;flex-shrink:0}.indBar{position:fixed;top:10px;right:0;left:0;display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:flex-end;padding:6px 9px;z-index:2600;background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,0));pointer-events:none}.indBadge{pointer-events:auto;display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);font-weight:1000;font-size:11px;color:#fff}.indBadge button{background:transparent;color:#fff;font-weight:1000;font-size:14px;line-height:1;padding:0 2px}.indBadge .name{cursor:pointer;user-select:none}.indSet{position:fixed;top:90px;right:9px;width:min(320px,calc(100vw - 18px));background:rgba(10,22,40,.88);border:1px solid rgba(255,255,255,.14);border-radius:14px;z-index:99999;backdrop-filter:blur(10px);padding:10px;display:none;box-shadow:0 14px 40px rgba(0,0,0,.65)}.indSet.show{display:block}.indSet .hd{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}.indSet .hd b{font-size:12px}.indSet .row{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:8px 0}.indSet label{font-size:11px;opacity:.9}.indSet input[type="color"]{width:44px;height:30px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,.15)}.indSet input[type="range"],.indSet input[type="number"]{flex:1;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.15);color:#fff;border-radius:8px;padding:6px;font-size:11px}.indSet .btns{display:flex;gap:8px;margin-top:10px}.indSet .btn{flex:1;padding:10px;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:#fff;font-weight:1000}.indSet .btn.primary{background:rgba(66,153,225,.22);border-color:rgba(66,153,225,.5)}.timeLabels{position:absolute;bottom:0;left:0;right:var(--psw);height:24px;background:var(--bg-primary);border-top:1px solid var(--border-primary);pointer-events:none;z-index:20}.timeLabel{position:absolute;bottom:2px;font-size:9px;font-weight:900;color:rgba(255,255,255,.6);transform:translateX(-50%);white-space:nowrap}.pair-box{position:absolute;left:9px;bottom:165px;z-index:22;display:inline-flex;align-items:center;gap:7px;background:var(--bg-secondary);border:1px solid var(--border-secondary);border-radius:11px;padding:6px 10px;cursor:pointer;user-select:none}.flag-icon-small{width:20px;height:13px;border-radius:2px}.pair-box .flags{display:flex;align-items:center;margin-inline:2px}.pair-box .flags img{width:24px;height:24px;border-radius:999px;border:2px solid var(--bg-card);margin-left:-9px;background:var(--bg-card)}.pair-box .otc{margin-inline-start:7px;padding:2px 7px;border-radius:999px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);font-size:11px;font-weight:1000;letter-spacing:.44px}.pairPanel{position:fixed;left:0;top:0;bottom:0;width:18vw;min-width:280px;max-width:420px;background:var(--bg-overlay);border-right:1.5px solid var(--border-primary);backdrop-filter:blur(10px);z-index:99998;transform:translateX(-105%);transition:transform .25s ease;pointer-events:auto;box-shadow:4px 0 24px rgba(0,0,0,.6)}.pairPanel.on{transform:translateX(0)}.pairHead{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1.5px solid var(--border-primary);background:linear-gradient(to bottom,rgba(255,255,255,.03),transparent);user-select:none}.pairHead b{font-size:15px;font-weight:1000;color:var(--text-primary);letter-spacing:.3px}.pairClose{width:36px;height:36px;border-radius:11px;background:rgba(255,255,255,.08);border:1.5px solid var(--border-primary);color:var(--text-secondary);font-weight:1000;transition:.2s}.pairList{padding:10px 12px;max-height:calc(100vh - 80px);overflow-y:auto}.pit{width:100%;display:flex;align-items:center;justify-content:space-between;gap:11px;padding:11px 13px;border-radius:13px;background:rgba(255,255,255,.03);border:1.5px solid var(--border-primary);color:var(--text-secondary);margin:7px 0;transition:.2s}.pit:hover{background:rgba(255,255,255,.05)}.pitL{display:flex;align-items:center;gap:11px;min-width:0}.star{width:20px;height:20px;border-radius:7px;background:rgba(255,159,42,.10);border:1px solid rgba(255,159,42,.30);display:grid;place-items:center;color:#ffb357;font-size:13px;flex:0 0 auto}.fg{display:flex;align-items:center}.fg img{width:24px;height:24px;border-radius:999px;border:2px solid var(--bg-card);margin-left:-9px;background:var(--bg-card)}.nm{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:1000}.bad{margin-inline-start:7px;padding:2px 7px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--border-primary);font-size:11px;font-weight:1000}.candleTimer{position:absolute;background:rgba(0,0,0,.85);color:#ffd700;padding:4px 9px;border-radius:7px;font-size:14px;font-weight:900;z-index:25;pointer-events:none;border:1px solid rgba(255,215,0,.4);display:none}.tradesPanel{position:fixed;bottom:0;left:0;right:0;height:40vh;background:linear-gradient(to top,rgba(10,22,40,.98),rgba(10,22,40,.92));backdrop-filter:blur(12px);border-top:2px solid var(--border-primary);z-index:9999;transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);box-shadow:0 -8px 32px rgba(0,0,0,.6)}.tradesPanel.open{transform:translateY(0)}.tradesPanelHeader{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1.5px solid var(--border-primary);background:rgba(0,0,0,.3)}.tradesPanelHeader h3{font-size:16px;font-weight:900;color:var(--text-primary);letter-spacing:.5px}.closeTrPanel{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.08);border:1.5px solid var(--border-primary);color:var(--text-secondary);font-size:20px;font-weight:900;transition:.2s}.tradesContent{padding:12px;overflow-y:auto;height:calc(40vh - 60px)}.tradeCard{background:rgba(255,255,255,.04);border:1.5px solid var(--border-primary);border-radius:12px;padding:12px;margin-bottom:10px;cursor:pointer;transition:.2s}.tradeCard:hover{background:rgba(255,255,255,.06)}.trL{display:flex;justify-content:space-between;align-items:center;gap:10px}.trTimer{font-size:20px;font-weight:1000;color:#ffd700}.trAmt{font-size:14px;font-weight:900}.trAmt.buy{color:#00ff88}.trAmt.sell{color:#ff5a4f}.trPair{font-size:13px;font-weight:900;color:rgba(255,255,255,.8)}.trProfit{font-size:16px;font-weight:1000}.trProfit.positive{color:#00ff41}.trProfit.negative{color:#ff0000}.trDetails{max-height:0;overflow:hidden;transition:max-height .3s ease;margin-top:0}.trDetails.open{max-height:500px;margin-top:12px}.trDRow{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.1);font-size:12px}.trDRow:last-child{border-bottom:none}.trDRow .label{color:rgba(255,255,255,.6)}.trDRow .value{font-weight:900}.miniChart{width:100%;height:80px;margin-top:10px;background:rgba(0,0,0,.3);border-radius:8px;position:relative}.fbStatus{position:fixed;top:10px;left:9px;z-index:9999;padding:6px 12px;border-radius:8px;font-size:11px;font-weight:900;backdrop-filter:blur(10px);border:1.5px solid;pointer-events:none;opacity:0;transition:opacity .3s}.fbStatus.show{opacity:1}.fbStatus.success{background:rgba(0,255,65,.15);border-color:#00ff41;color:#00ff41}.fbStatus.error{background:rgba(255,0,0,.15);border-color:#ff0000;color:#ff0000}.roleTag{position:fixed;left:9px;top:50px;padding:4px 10px;background:rgba(66,153,225,.22);border:1.5px solid rgba(66,153,225,.5);border-radius:8px;font-size:10px;font-weight:900;color:#4299e1;z-index:25;backdrop-filter:blur(10px)}</style><body><div class="chartWrap"><div id="sk" class="on"></div><div class="chartFrame"><div class="tc"><div class="centerLine"></div><div class="pair-box" id="pairHud"><span id="pairHudTxt">EUR/USD</span><span class="otc" id="otcHud">OTC</span><span class="flags" id="pairFlags"></span><span style="opacity:.7">‚ñæ</span></div><canvas id="c"></canvas><div class="candleTimer" id="candleTimer">59</div><div class="ps" id="ps"></div><div class="timeLabels" id="timeLabels"></div></div></div></div><div class="fbStatus" id="fbStatus"></div><div class="roleTag" id="roleTag" style="display:none"></div><div class="platformTime" id="platTime">UTC+3 00:00:00</div><div class="indBar" id="indBar"></div><div class="indSet" id="indSet"><div class="hd"><b id="indSetTitle">Indicator</b><button class="btn" id="indSetClose">ÿ•ÿ∫ŸÑÿßŸÇ</button></div><div class="row"><label>Color</label><input type="color" id="indColor" value="#ffff00"></div><div class="row"><label>Width</label><input type="number" id="indWidth" min="1" max="8" step="1" value="2"></div><div class="row" id="periodRow" style="display:none"><label>Period</label><input type="number" id="indPeriod" min="2" max="200" step="1" value="20"></div><div class="row" id="stdRow" style="display:none"><label>Std Dev</label><input type="number" id="indStd" min="0.1" max="5" step="0.1" value="2"></div><div class="btns"><button class="btn" id="indRemove">Delete</button></div></div><div class="datetime" id="datetime"></div><div class="indicatorIcons"><div class="indIcon" id="indBtn1"><img src="https://cdn-icons-png.flaticon.com/128/742/742130.png"></div><div class="indIcon" id="indBtn2"><img src="https://cdn-icons-png.flaticon.com/128/561/561184.png"></div><div class="eyeIcon" id="eyeBtn">üëÅ</div><div class="indNamesList" id="indNamesList"></div></div><div class="pairPanel" id="pairPanel"><div class="pairHead"><b>ÿßŸÑÿßÿ≤Ÿàÿßÿ¨</b><button class="pairClose" id="pairClose">√ó</button></div><div class="pairList" id="pairList"></div></div><div class="indicatorsPanel" id="indicatorsPanel"><div class="indPanelHead"><h3>Indicators</h3><button class="closeIndBtn" id="closeIndBtn">√ó</button></div><div class="indItem" data-ind="aco"><span>Accelerator Oscillator</span></div><div class="indItem" data-ind="adx"><span>ADX</span></div><div class="indItem" data-ind="alligator"><span>Alligator</span></div><div class="indItem" data-ind="aroon"><span>Aroon</span></div><div class="indItem" data-ind="atr"><span>ATR</span></div><div class="indItem" data-ind="awesome"><span>Awesome Oscillator</span></div><div class="indItem" data-ind="bearpower"><span>Bears Power</span></div><div class="indItem" data-ind="bb"><span>Bollinger Bands</span></div><div class="indItem" data-ind="bbw"><span>Bollinger Bands Width</span></div><div class="indItem" data-ind="bullpower"><span>Bulls Power</span></div><div class="indItem" data-ind="cci"><span>CCI</span></div><div class="indItem" data-ind="donchian"><span>Donchian Channel</span></div><div class="indItem" data-ind="demarker"><span>DeMarker</span></div><div class="indItem" data-ind="envelopes"><span>Envelopes</span></div><div class="indItem" data-ind="fractal"><span>Fractal</span></div><div class="indItem" data-ind="fcb"><span>Fractal Chaos Bands</span></div><div class="indItem" data-ind="ichimoku"><span>Ichimoku</span></div><div class="indItem" data-ind="keltner"><span>Keltner Channel</span></div><div class="indItem" data-ind="macd"><span>MACD</span></div><div class="indItem" data-ind="momentum"><span>Momentum</span></div><div class="indItem" data-ind="ma"><span>Moving Average</span></div><div class="indItem" data-ind="mao"><span>Moving Average Oscillator</span></div><div class="indItem" data-ind="psar"><span>Parabolic SAR</span></div><div class="indItem" data-ind="rsi"><span>RSI</span></div><div class="indItem" data-ind="roc"><span>ROC</span></div><div class="indItem" data-ind="schaff"><span>Schaff Trend Cycle</span></div><div class="indItem" data-ind="stochastic"><span>Stochastic</span></div><div class="indItem" data-ind="supertrend"><span>SuperTrend</span></div><div class="indItem" data-ind="volume"><span>Volume</span></div><div class="indItem" data-ind="vortex"><span>Vortex</span></div><div class="indItem" data-ind="williamsr"><span>Williams %R</span></div><div class="indItem" data-ind="zigzag"><span>ZigZag</span></div><div class="indItem" data-ind="tl"><span>Trendline</span></div></div><div class="tradesPanel" id="tradesPanel"><div class="tradesPanelHeader"><h3>üìä Active Trades</h3><button class="closeTrPanel" id="closeTrPanel">√ó</button></div><div class="tradesContent" id="tradesContent"></div></div><div class="trading-controls"><div class="control-row"><div class="input-wrapper"><button class="ctrl-btn" id="minus">-</button><input class="input-field" value="$ 1" id="amountInput"><button class="ctrl-btn" id="plus">+</button></div><div class="input-wrapper" id="timeWrapper"><input class="input-field" value="00:01:00" id="timeInput" readonly><div class="timePickerPopup" id="timePickerPopup"><div class="timeGrid"><button class="timeBtn" data-time="00:00:15">15s</button><button class="timeBtn" data-time="00:00:10">10s</button><button class="timeBtn" data-time="00:00:05">5s</button><button class="timeBtn" data-time="00:02:00">2m</button><button class="timeBtn" data-time="00:01:00">1m</button><button class="timeBtn" data-time="00:00:30">30s</button><button class="timeBtn" data-time="00:15:00">15m</button><button class="timeBtn" data-time="00:10:00">10m</button><button class="timeBtn" data-time="00:05:00">5m</button><button class="timeBtn" data-time="02:00:00">2h</button><button class="timeBtn" data-time="01:00:00">1h</button><button class="timeBtn" data-time="00:30:00">30m</button></div><button class="manualBtn" id="manualBtn">ÿ∂ÿ®ÿ∑ ŸäÿØŸàŸäÿßŸã</button></div></div></div></div><div class="tradeDock"><div class="trading-buttons"><button class="trade-btn trade-higher" id="buy"><svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5z"></path></svg><span>Buy</span></button><button class="trade-btn trade-lower" id="sell"><svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"></path></svg><span>Sell</span></button></div></div><script type="module">import{initializeApp as iA}from"https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";import{getFirestore as gFS,doc as D,setDoc as sD,getDoc as gD,onSnapshot as oS,deleteField as dF}from"https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";const fC={apiKey:"AIzaSyBOUqLixfphg3b8hajc4hkwV-VJmldGBVw",authDomain:"randers-c640b.firebaseapp.com",projectId:"randers-c640b",storageBucket:"randers-c640b.firebasestorage.app",messagingSenderId:"391496092929",appId:"1:391496092929:web:58208b4eb3e6f9a8571f00"},app=iA(fC),db=gFS(app),shSt=(m,t)=>{const s=document.getElementById("fbStatus");s.textContent=m;s.className="fbStatus show "+(t||"success");setTimeout(()=>s.classList.remove("show"),2500)},svFB=async(p,d)=>{try{const k=p.replace(/\//g,"_");await sD(D(db,"candles",k),{cs:d,lu:Date.now()},{merge:!1});console.log("‚úì ÿ≠ŸÅÿ∏:",p,d.length)}catch(e){console.error("‚ùå ÿÆÿ∑ÿ£:",e);shSt("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ŸÅÿ∏","error")}},ldFB=async p=>{try{const k=p.replace(/\//g,"_"),s=await gD(D(db,"candles",k));if(s.exists()){const dt=s.data();console.log("‚úì ÿ™ÿ≠ŸÖŸäŸÑ:",p,dt.cs?.length||0);return dt.cs||[]}return[]}catch(e){console.error("‚ùå ÿÆÿ∑ÿ£:",e);return[]}},svLV=async(p,c)=>{try{const k="live_"+p.replace(/\//g,"_"),sID=sessionStorage.getItem("sessID")||"";await sD(D(db,"live",k),{cc:c,t:Date.now(),mID:sID},{merge:!0})}catch(e){console.error("‚ùå ÿÆÿ∑ÿ£:",e)}},clMgr=async p=>{try{const k="live_"+p.replace(/\//g,"_");await sD(D(db,"live",k),{mID:dF()},{merge:!0})}catch(e){console.error("‚ùå ÿÆÿ∑ÿ£:",e)}},svTr=()=>{try{localStorage.setItem("trades",JSON.stringify(st.trades))}catch(e){console.error("‚ùå ÿ≠ŸÅÿ∏ ÿµŸÅŸÇÿßÿ™:",e)}},ldTr=()=>{try{const d=localStorage.getItem("trades");if(d){const t=JSON.parse(d);st.trades=t.filter(x=>x.pair===chart.pair);rTP()}}catch(e){console.error("‚ùå ÿ™ÿ≠ŸÖŸäŸÑ ÿµŸÅŸÇÿßÿ™:",e)}};const $=i=>document.getElementById(i),clp=(v,a,b)=>Math.max(a,Math.min(b,v)),fM={AED:"ae",CNY:"cn",AUD:"au",CAD:"ca",CHF:"ch",BHD:"bh",EUR:"eu",RUB:"ru",USD:"us",KES:"ke",LBP:"lb",QAR:"qa",TRY:"tr",SYP:"sy",EGP:"eg",INR:"in",IRR:"ir"},mkF=c=>`https://flagcdn.com/w40/${(fM[c]||c||"un").toLowerCase()}.png`,dP=[{pair:"AED/CNY",otc:1,payout:.91,flags:["AED","CNY"],price:7.2,seed:11001,digits:3},{pair:"AUD/CAD",otc:1,payout:.88,flags:["AUD","CAD"],price:.91,seed:11002,digits:5},{pair:"AUD/CHF",otc:1,payout:.92,flags:["AUD","CHF"],price:.55,seed:11003,digits:5},{pair:"BHD/CNY",otc:1,payout:.86,flags:["BHD","CNY"],price:19.8,seed:11004,digits:3},{pair:"EUR/RUB",otc:1,payout:.77,flags:["EUR","RUB"],price:97.4,seed:11005,digits:2},{pair:"EUR/USD",otc:1,payout:.92,flags:["EUR","USD"],price:1.0895,seed:33333,digits:5},{pair:"KES/USD",otc:1,payout:.84,flags:["KES","USD"],price:.0077,seed:11006,digits:6},{pair:"LBP/USD",otc:1,payout:.79,flags:["LBP","USD"],price:.000011,seed:11007,digits:8},{pair:"QAR/CNY",otc:1,payout:.83,flags:["QAR","CNY"],price:1.97,seed:11008,digits:4},{pair:"USD/CHF",otc:1,payout:.89,flags:["USD","CHF"],price:.91,seed:11009,digits:5},{pair:"SYP/TRY",otc:1,payout:.87,flags:["SYP","TRY"],price:.00013,seed:11010,digits:7},{pair:"EGP/USD",otc:1,payout:.78,flags:["EGP","USD"],price:.032,seed:11011,digits:5},{pair:"USD/INR",otc:1,payout:.90,flags:["USD","INR"],price:83.2,seed:11012,digits:2}];const st={pairs:new Map,fav:new Set,trades:[],inds:[]};dP.forEach(x=>st.pairs.set(x.pair,x));const upPF=(p,c)=>{const m=st.pairs.get(p)||dP.find(x=>x.pair===p);if(!m)return;const f=m.flags||String(p).split("/");c.innerHTML=f.map(x=>`<img src="${mkF(x)}" class="flag-icon-small">`).join("")},fP=p=>Math.round((+p||0)*100)+"%",rPP=()=>{const pl=$("pairList");if(!pl)return;const ar=[...st.pairs.values()].sort((a,b)=>{const fa=st.fav.has(a.pair)?1:0,fb=st.fav.has(b.pair)?1:0;if(fa!==fb)return fb-fa;return a.pair.localeCompare(b.pair)});pl.innerHTML=ar.map(x=>{const[a,b]=String(x.pair).split("/"),st2=st.fav.has(x.pair)?"‚òÖ":"‚òÜ";return`<button class="pit" data-p="${x.pair}"><span class="pitL"><span class="star" data-s="1">${st2}</span><span class="fg"><img src="${mkF(a)}"><img src="${mkF(b)}"></span><span class="nm">${x.pair}<span class="bad">OTC</span></span></span><span>+${fP(x.payout)}</span></button>`}).join("")};let isMgr=!1,shIN=1,sID="",bal=10000;const uid=()=>Math.random().toString(36).slice(2,9),nS=v=>{if(!(v>0))return 1;const p=Math.pow(10,Math.floor(Math.log10(v))),n=v/p;return(n<=1?1:n<=2?2:n<=5?5:10)*p},pD=s=>{const m=s.match(/^(\d{2}):(\d{2}):(\d{2})$/);if(!m)return 6e4;return(+m[1]*3600+ +m[2]*60+ +m[3])*1e3},fT=ms=>{const s=Math.floor(ms/1e3),m=Math.floor(s/60),h=Math.floor(m/60);return h>0?`${h}:${String(m%60).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`:`${m%60}:${String(s%60).padStart(2,"0")}`},fDT=ts=>{const d=new Date(ts);return`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`};function cPf(tr,cp){const pI=st.pairs.get(tr.pair),po=pI?pI.payout:.85,pp=tr.type==="buy"?cp-tr.openPrice:tr.openPrice-cp;return pp>0?tr.amount*(1+po):pp<0?-tr.amount:0}function rTP(){const tc=$("tradesContent"),as=st.trades.filter(t=>t.pair===chart.pair);if(!as.length){tc.innerHTML='<p style="text-align:center;color:rgba(255,255,255,.5);padding:20px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸÅŸÇÿßÿ™</p>';return}tc.innerHTML=as.map((tr,i)=>{const now=Date.now(),lf=Math.max(0,tr.openTime+tr.duration-now),cp=window.chart&&chart.cc?chart.cc.close:tr.openPrice,pf=cPf(tr,cp),pfC=pf>0?"positive":pf<0?"negative":"",aC=tr.type==="buy"?"buy":"sell",cls=tr.closed?"":"";return`<div class="tradeCard" data-idx="${i}"><div class="trL"><div style="display:flex;gap:10px;align-items:center;"><div class="trTimer">${tr.closed?"ÿßŸÜÿ™Ÿáÿ™":fT(lf)}</div><div class="trAmt ${aC}">$${tr.amount}</div></div><div style="display:flex;gap:10px;align-items:center;"><div class="trPair">${tr.pair}</div><div class="trProfit ${pfC}">$${pf.toFixed(2)}</div></div></div>${tr.closed?`<div class="trDetails" id="trD${i}"><div class="trDRow"><span class="label">ÿ≥ÿπÿ± ÿßŸÑŸÅÿ™ÿ≠:</span><span class="value">${tr.openPrice.toFixed(chart.d.digits)}</span></div><div class="trDRow"><span class="label">ÿ≥ÿπÿ± ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ:</span><span class="value">${(tr.closePrice||0).toFixed(chart.d.digits)}</span></div><div class="trDRow"><span class="label">ŸàŸÇÿ™ ÿßŸÑŸÅÿ™ÿ≠:</span><span class="value">${fDT(tr.openTime)}</span></div><div class="trDRow"><span class="label">ŸàŸÇÿ™ ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ:</span><span class="value">${fDT(tr.closeTime||0)}</span></div><div class="trDRow"><span class="label">ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©:</span><span class="value ${pfC}">${pf>0?"ÿ±ÿ®ÿ≠":pf<0?"ÿÆÿ≥ÿßÿ±ÿ©":"ÿ™ÿπÿßÿØŸÑ"}</span></div><div class="trDRow"><span class="label">ÿßŸÑŸÖÿ®ŸÑÿ∫:</span><span class="value ${pfC}">$${pf.toFixed(2)}</span></div><canvas class="miniChart" id="mC${i}" width="300" height="80"></canvas></div>`:""}</div>`}).join("");as.forEach((tr,i)=>{if(tr.closed){const cv=$("mC"+i);if(cv){const cx=cv.getContext("2d"),w=300,h=80,pts=tr.priceHistory||[];cx.clearRect(0,0,w,h);if(pts.length>1){const mn=Math.min(...pts),mx=Math.max(...pts),rg=mx-mn||1;cx.strokeStyle=tr.type==="buy"?"#00ff88":"#ff5a4f";cx.lineWidth=2;cx.beginPath();pts.forEach((p,j)=>{const x=j/(pts.length-1)*w,y=h-(p-mn)/rg*h;j===0?cx.moveTo(x,y):cx.lineTo(x,y)});cx.stroke()}}}})}function rIN(){const bx=$("indNamesList"),ey=$("eyeBtn");if(st.inds.length===0){ey.style.display="none";bx.style.display="none";return}ey.style.display="flex";bx.style.display=shIN?"flex":"none";bx.innerHTML=(st.inds||[]).map((_,i)=>`<div class="nmIt" data-idx="${i}">${i+1}</div>`).join("");bx.querySelectorAll(".nmIt").forEach(el=>el.onclick=()=>{const idx=+el.dataset.idx;if(st.inds[idx]){eI=st.inds[idx];oIS(eI)}})}class Chart{constructor(){this.cv=$("c");this.ctx=this.cv.getContext("2d");this.host=this.cv.closest(".tc");this.cs=[];this.cc=null;this.baseSpacing=12;this.baseCandleWidth=8;this.drag=0;this.dragStartX=0;this.dragStartScroll=0;this.manualScrollOffset=0;this.targetScrollOffset=0;this.momentum=0;this.lastDragDelta=0;this.lastDragTime=0;this.tf=6e4;this.t0=Math.floor(Date.now()/6e4)*6e4;this.minZoom=.5;this.maxZoom=50;this.tlDrag=null;this.zoom=1;this.targetZoom=1;this.zoomEase=.18;this.priceInd=null;this.scaleMark=null;this.on=0;this.switching=0;this.candleWidthMultiplier=1;this.priceCompression=1;this.tickTimer=null;this.loopFrame=null;this.liveUnsub=null;this.hbInt=null;this.mgrChkInt=null;this.setup();this.ev()}async setPair(p){const m=st.pairs.get(p)||st.pairs.get("EUR/USD");this.pair=p;this.d={price:m.price,seed:m.seed,digits:m.digits};this.cp=this.d.price;this.priceRange={min:this.d.price*.95,max:this.d.price*1.05}}setup(){const dpr=devicePixelRatio||1,r=this.host.getBoundingClientRect();this.w=Math.max(0,r.width);this.h=Math.max(0,r.height-24);this.cv.width=Math.floor(this.w*dpr);this.cv.height=Math.floor(this.h*dpr);this.cv.style.width=this.w+"px";this.cv.style.height=this.h+"px";this.ctx.setTransform(dpr,0,0,dpr,0,0);if(!this.priceInd){this.priceInd=document.createElement("div");this.priceInd.className="priceIndicator";this.host.appendChild(this.priceInd)}if(!this.scaleMark){this.scaleMark=document.createElement("div");this.scaleMark.className="priceScaleMark";this.host.appendChild(this.scaleMark)}}async switchPair(p){if(this.switching)return;this.switching=1;this.on=0;if(this.tickTimer){clearTimeout(this.tickTimer);this.tickTimer=null}if(this.loopFrame){cancelAnimationFrame(this.loopFrame);this.loopFrame=null}if(this.liveUnsub){this.liveUnsub();this.liveUnsub=null}if(this.hbInt){clearInterval(this.hbInt);this.hbInt=null}if(this.mgrChkInt){clearInterval(this.mgrChkInt);this.mgrChkInt=null}if(isMgr)await clMgr(this.pair);$("sk").classList.add("on");await this.setPair(p);const fb=await ldFB(p);this.cs=fb&&fb.length>0?[...fb]:[];this.cc=null;this.momentum=0;this.drag=0;if(this.cs.length>0){this.t0=this.cs[this.cs.length-1].timestamp+this.tf;this.cp=this.cs[this.cs.length-1].close}else{this.t0=Math.floor(Date.now()/6e4)*6e4;this.cp=this.d.price;await this.iCL(100)}$("pairHudTxt").textContent=p;upPF(p,$("pairFlags"));this.priceRange={min:this.d.price*.95,max:this.d.price*1.05};this.snapToLive();this.updatePriceRange();this.updatePriceScale();this.updateTimeLabels();await this.chkMR();this.subLV();this.stMC();ldTr();this.switching=0;this.on=1;this.tick();this.loop();$("sk").classList.remove("on")}async chkMR(){const k="live_"+this.pair.replace(/\//g,"_");try{const s=await gD(D(db,"live",k));if(!s.exists()||!s.data().mID){isMgr=!0;sID=sessionStorage.getItem("sessID")||uid();sessionStorage.setItem("sessID",sID);await sD(D(db,"live",k),{mID:sID,t:Date.now()},{merge:!0});$("roleTag").textContent="üéØ ŸÖÿØŸäÿ±";$("roleTag").style.display="block";this.stHB()}else{const dt=s.data(),cM=dt.mID,lT=dt.t||0,nw=Date.now();if(cM===sID){isMgr=!0;$("roleTag").textContent="üéØ ŸÖÿØŸäÿ±";$("roleTag").style.display="block";this.stHB()}else if(nw-lT>15e3){isMgr=!0;sID=sessionStorage.getItem("sessID")||uid();sessionStorage.setItem("sessID",sID);await sD(D(db,"live",k),{mID:sID,t:Date.now()},{merge:!0});$("roleTag").textContent="üéØ ŸÖÿØŸäÿ±";$("roleTag").style.display="block";this.stHB()}else{isMgr=!1;$("roleTag").textContent="üëÅ ŸÖÿ¥ÿßŸáÿØ";$("roleTag").style.display="block"}}}catch(e){isMgr=!0;sID=sessionStorage.getItem("sessID")||uid();sessionStorage.setItem("sessID",sID);$("roleTag").textContent="üéØ ŸÖÿØŸäÿ±";$("roleTag").style.display="block";this.stHB()}}stHB(){if(this.hbInt)clearInterval(this.hbInt);this.hbInt=setInterval(async()=>{if(!isMgr)return;const k="live_"+this.pair.replace(/\//g,"_");try{await sD(D(db,"live",k),{mID:sID,t:Date.now()},{merge:!0})}catch(e){console.error("‚ùå HB:",e)}},5e3)}stMC(){if(this.mgrChkInt)clearInterval(this.mgrChkInt);this.mgrChkInt=setInterval(async()=>{if(isMgr)return;const k="live_"+this.pair.replace(/\//g,"_");try{const s=await gD(D(db,"live",k));if(s.exists()){const dt=s.data(),cM=dt.mID,lT=dt.t||0,nw=Date.now();if(!cM||nw-lT>15e3){isMgr=!0;sID=sessionStorage.getItem("sessID")||uid();sessionStorage.setItem("sessID",sID);await sD(D(db,"live",k),{mID:sID,t:Date.now()},{merge:!0});$("roleTag").textContent="üéØ ŸÖÿØŸäÿ±";$("roleTag").style.display="block";this.stHB()}}else{isMgr=!0;sID=sessionStorage.getItem("sessID")||uid();sessionStorage.setItem("sessID",sID);await sD(D(db,"live",k),{mID:sID,t:Date.now()},{merge:!0});$("roleTag").textContent="üéØ ŸÖÿØŸäÿ±";$("roleTag").style.display="block";this.stHB()}}catch(e){console.error("‚ùå MC:",e)}},3e3)}subLV(){if(this.liveUnsub)this.liveUnsub();const k="live_"+this.pair.replace(/\//g,"_");this.liveUnsub=oS(D(db,"live",k),async s=>{if(!s.exists()||!this.on)return;const dt=s.data();if(!isMgr&&dt.cc){this.cc={...dt.cc};this.cp=this.cc.close}if(dt.mID){const cM=dt.mID,lT=dt.t||0,nw=Date.now();if(isMgr&&cM!==sID&&nw-lT<=15e3){isMgr=!1;$("roleTag").textContent="üëÅ ŸÖÿ¥ÿßŸáÿØ";$("roleTag").style.display="block";if(this.hbInt){clearInterval(this.hbInt);this.hbInt=null}}else if(!isMgr&&(cM===sID||nw-lT>15e3)){isMgr=!0;sID=sessionStorage.getItem("sessID")||uid();sessionStorage.setItem("sessID",sID);await sD(D(db,"live",k),{mID:sID,t:Date.now()},{merge:!0});$("roleTag").textContent="üéØ ŸÖÿØŸäÿ±";$("roleTag").style.display="block";this.stHB()}}},{includeMetadataChanges:!1})}tickZoom(){const dz=this.targetZoom-this.zoom;this.zoom=Math.abs(dz)>.0001?this.zoom+dz*this.zoomEase:this.targetZoom}getSpacing(){return this.baseSpacing*this.zoom}getCandleWidth(){return Math.max(1,this.baseCandleWidth*this.zoom*this.candleWidthMultiplier)}getMinScrollOffset(){return this.w/2-this.cs.length*this.getSpacing()}getMaxScrollOffset(){return this.w/2}clampPan(){const mn=this.getMinScrollOffset(),mx=this.getMaxScrollOffset();this.targetScrollOffset=clp(this.targetScrollOffset,mn,mx);this.manualScrollOffset=clp(this.manualScrollOffset,mn,mx)}snapToLive(){this.targetScrollOffset=this.getMinScrollOffset();this.manualScrollOffset=this.targetScrollOffset;this.momentum=0;this.clampPan()}smoothScroll(){let df=this.targetScrollOffset-this.manualScrollOffset;if(Math.abs(df)>.001){const cp=this.getSpacing()*.45;df=clp(df,-cp,cp);this.manualScrollOffset+=df*.35}else this.manualScrollOffset=this.targetScrollOffset}applyMomentum(){if(Math.abs(this.momentum)>.1){this.targetScrollOffset+=this.momentum;this.momentum*=.94}else this.momentum=0}getScrollOffset(){this.applyMomentum();this.smoothScroll();this.clampPan();return this.manualScrollOffset}indexToX(i){return this.getScrollOffset()+i*this.getSpacing()}xToIndex(x){return(x-this.getScrollOffset())/this.getSpacing()}rnd(s){const x=Math.sin(s)*1e4;return x-Math.floor(x)}rndG(s){const u1=this.rnd(s),u2=this.rnd(s+1e5);return Math.sqrt(-2*Math.log(u1+1e-10))*Math.cos(2*Math.PI*u2)}genCandle(t,op){const s=this.d.seed+Math.floor(t/this.tf);const vBase=.0008,tBase=.00005;const r1=this.rndG(s),r2=this.rndG(s+1),r3=this.rndG(s+2),r4=this.rnd(s+3),r5=this.rnd(s+4),r6=this.rnd(s+5);const vl=vBase*(.7+Math.abs(r1)*.8);const tr=tBase*r2*.6;const dr=r3>0?1:-1;const tg=op+(dr*vl+tr);const rv=vl*(.2+r4*.6);const hm=rv*(.3+r5*.7),lm=rv*(.3+(1-r5)*.7);const dg=this.d.digits,cl=+(tg+(r6-.5)*vl*.1).toFixed(dg),o=+op.toFixed(dg);return{open:o,close:cl,high:+Math.max(o,cl,o+hm,cl+hm).toFixed(dg),low:+Math.min(o,cl,o-lm,cl-lm).toFixed(dg),timestamp:t}}getPriceRange(){const c=(this.priceRange.min+this.priceRange.max)/2,hr=((this.priceRange.max-this.priceRange.min)/2)/(1*this.priceCompression);return{min:c-hr,max:c+hr}}priceToY(p){const r=this.getPriceRange(),n=(p-r.min)/(r.max-r.min);return this.h*(1-n)}yToPrice(y){const r=this.getPriceRange(),n=1-(y/this.h);return r.min+n*(r.max-r.min)}updatePriceRange(){let v=[...this.cs];if(this.cc&&(!v.length||this.cc.timestamp!==v[v.length-1].timestamp))v.push(this.cc);if(!v.length){this.priceRange={min:this.d.price*.95,max:this.d.price*1.05};return}const s=Math.floor(this.xToIndex(0)),e=Math.ceil(this.xToIndex(this.w)),vs=v.slice(Math.max(0,s-5),Math.min(v.length,e+5));if(!vs.length){this.priceRange={min:this.d.price*.95,max:this.d.price*1.05};return}const lw=vs.map(x=>x.low),hg=vs.map(x=>x.high),mn=Math.min(...lw),mx=Math.max(...hg),pd=(mx-mn)*.15||1e-9;this.priceRange={min:mn-pd,max:mx+pd}}gridSteps(){const r=this.getPriceRange(),sp=r.max-r.min,sP=nS(sp/8),tS=this.tf*(this.w/this.getSpacing());let sT=nS(tS/7);const al=[5e3,1e4,15e3,3e4,6e4,12e4,3e5,6e5,9e5,18e5,36e5,72e5];sT=al.reduce((a,b)=>Math.abs(b-sT)<Math.abs(a-sT)?b:a,al[0]);return{stepP:sP,stepT:sT}}drawGrid(){const r=this.getPriceRange(),{stepP,stepT}=this.gridSteps();this.ctx.lineWidth=1;this.ctx.strokeStyle="rgba(255,255,255,.16)";let p0=Math.floor(r.min/stepP)*stepP;for(let p=p0;p<=r.max+stepP*1.001;p+=stepP){const y=this.priceToY(p);if(y<0||y>this.h)continue;this.ctx.beginPath();this.ctx.moveTo(0,y+.5);this.ctx.lineTo(this.w,y+.5);this.ctx.stroke()}const s=Math.floor(this.xToIndex(0))-2,e=Math.ceil(this.xToIndex(this.w))+2,tS=this.cs.length?this.cs[0].timestamp:(this.t0-this.tf*this.cs.length);for(let i=s;i<=e;i++){const t=tS+i*this.tf;if(((t-(Math.floor(tS/stepT)*stepT))%stepT)!==0)continue;const x=this.indexToX(i);if(x<0||x>this.w)continue;this.ctx.beginPath();this.ctx.moveTo(x+.5,0);this.ctx.lineTo(x+.5,this.h);this.ctx.stroke()}}updateTimeLabels(){const tl=$("timeLabels");tl.innerHTML="";const{stepT}=this.gridSteps(),s=Math.floor(this.xToIndex(0))-2,e=Math.ceil(this.xToIndex(this.w))+2,tS=this.cs.length?this.cs[0].timestamp:(this.t0-this.tf*this.cs.length);for(let i=s;i<=e;i++){const t=tS+i*this.tf;if(((t-(Math.floor(tS/stepT)*stepT))%stepT)!==0)continue;const x=this.indexToX(i);if(x<5||x>this.w-5)continue;const d=new Date(t),hh=String(d.getHours()).padStart(2,"0"),mm=String(d.getMinutes()).padStart(2,"0"),ss=String(d.getSeconds()).padStart(2,"0"),lb=document.createElement("div");lb.className="timeLabel";lb.style.left=x+"px";lb.textContent=(stepT<6e4?`${hh}:${mm}:${ss}`:`${hh}:${mm}`);tl.appendChild(lb)}}updatePriceScale(){const pC=$("ps");pC.innerHTML="";const r=this.getPriceRange(),{stepP}=this.gridSteps();let p0=Math.floor(r.min/stepP)*stepP,n=0;for(let p=p0;p<=r.max+stepP*1.001;p+=stepP){const y=this.priceToY(p);if(y<0||y>this.h)continue;const lb=document.createElement("div");lb.className="pl";lb.style.top=y+"px";lb.textContent=(+p).toFixed(this.d.digits);pC.appendChild(lb);if(++n>20)break}}updatePriceIndicator(){if(!this.cc||!this.priceInd)return;const cp=this.cc.close,y=this.priceToY(cp);this.priceInd.textContent=cp.toFixed(this.d.digits);this.priceInd.style.top=y+"px";this.priceInd.style.display="block";if(this.scaleMark){this.scaleMark.style.top=y+"px";this.scaleMark.style.display="block"}}drawCurrentPriceLine(){if(!this.cc)return;const y=this.priceToY(this.cc.close);this.ctx.strokeStyle="rgba(255,215,0,.35)";this.ctx.lineWidth=1;this.ctx.setLineDash([6,6]);this.ctx.beginPath();this.ctx.moveTo(0,y+.5);this.ctx.lineTo(this.w,y+.5);this.ctx.stroke();this.ctx.setLineDash([])}updateCandleTimer(){const nw=Date.now(),el=nw-this.t0,lf=Math.max(0,Math.ceil((this.tf-el)/1e3)),cT=$("candleTimer");cT.textContent=String(lf);if(this.cc){const x=this.indexToX(this.cs.length),y=this.priceToY(this.cc.close);x>=-60&&x<=this.w+60?(cT.style.left=Math.max(10,Math.min(this.w-60,x+25))+"px",cT.style.top=Math.max(10,Math.min(this.h-30,y-15))+"px",cT.style.display="block"):cT.style.display="none"}else cT.style.display="none"}drawTradeMarkersCanvas(){if(!this.cc)return;const nw=Date.now();for(const tr of st.trades){if(tr.closed)continue;if(tr.pair!==this.pair)continue;if(tr.candleIndex!==this.cs.length)continue;const x=this.indexToX(this.cs.length);const y=this.priceToY(tr.openPrice);const cl=tr.type==="buy"?"#00ff88":"#ff5a4f";this.ctx.save();this.ctx.strokeStyle=cl;this.ctx.fillStyle=cl;this.ctx.lineWidth=2;this.ctx.beginPath();this.ctx.arc(x,y,3,0,Math.PI*2);this.ctx.fill();this.ctx.globalAlpha=.7;this.ctx.beginPath();this.ctx.moveTo(x,y);this.ctx.lineTo(x-60,y);this.ctx.stroke();this.ctx.globalAlpha=1;this.ctx.font="900 12px system-ui";this.ctx.textAlign="right";this.ctx.textBaseline="middle";const lf=Math.max(0,tr.openTime+tr.duration-nw);this.ctx.fillText((tr.type==="buy"?"‚ñ≤ ":"‚ñº ")+("$"+tr.amount),x-66,y-10);this.ctx.globalAlpha=.7;this.ctx.font="900 11px system-ui";this.ctx.fillText(fT(lf),x-66,y+10);this.ctx.restore()}}async iCL(n=100){const lc=this.cs.length>0?this.cs[this.cs.length-1].close:this.d.price,st2=this.cs.length>0?this.cs[this.cs.length-1].timestamp+this.tf:this.t0-this.tf*n;let b=lc;for(let i=0;i<n;i++){const t=st2+i*this.tf,cd=this.genCandle(t,b);this.cs.push(cd);b=cd.close}this.cp=b;await svFB(this.pair,this.cs);shSt("‚úÖ ÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ "+n+" ÿ¥ŸÖÿπÿ©")}stepTowards(cr,tg,mS){const d=tg-cr;return Math.abs(d)<=mS?tg:cr+Math.sign(d)*mS}updateCurrentCandle(){if(!isMgr)return;if(!this.cc){const lp=this.cs.length?this.cs[this.cs.length-1].close:this.cp;this.cc=this.genCandle(this.t0,lp);this.cc.close=lp;this.cc.high=Math.max(this.cc.open,this.cc.close);this.cc.low=Math.min(this.cc.open,this.cc.close);return}const nw=Date.now(),sd=this.d.seed+nw,r=this.rnd(sd),dr=(r-.5)*.0004,tg=this.cc.close+dr,mS=.0008*.18,nc=+this.stepTowards(this.cc.close,tg,mS).toFixed(this.d.digits);this.cc.close=nc;this.cc.high=+Math.max(this.cc.high,nc).toFixed(this.d.digits);this.cc.low=+Math.min(this.cc.low,nc).toFixed(this.d.digits);this.cp=nc;svLV(this.pair,this.cc);this.updateTrades()}updateTrades(){if(!this.cc)return;const nw=Date.now(),cp=this.cc.close;st.trades.forEach(tr=>{if(tr.closed)return;if(tr.pair!==this.pair)return;if(!tr.priceHistory)tr.priceHistory=[];tr.priceHistory.push(cp);const el=nw-tr.openTime;if(el>=tr.duration){const pf=cPf(tr,cp);tr.profit=pf;tr.closePrice=cp;tr.closeTime=nw;tr.closed=1;bal+=pf;svTr()}else tr.profit=cPf(tr,cp)});rTP()}async tick(){if(!this.on)return;const nw=Date.now(),el=nw-this.t0;if(el>=this.tf){if(isMgr&&this.cc){if(!this.cs.length||this.cs[this.cs.length-1].timestamp!==this.cc.timestamp){this.cs.push({...this.cc});await svFB(this.pair,this.cs)}}this.t0=Math.floor(nw/this.tf)*this.tf;const lp=this.cc?this.cc.close:this.cp;this.cc=this.genCandle(this.t0,lp);this.cc.open=lp;this.cc.close=lp;this.cc.high=lp;this.cc.low=lp;this.cp=lp}else if(isMgr)this.updateCurrentCandle();this.updatePriceRange();this.updatePriceScale();this.updateTimeLabels();this.updateCandleTimer();this.updatePriceIndicator();this.tickTimer=setTimeout(()=>this.tick(),200)}drawCandle(cd,x,lv){const o=this.priceToY(cd.open),cl=this.priceToY(cd.close),hi=this.priceToY(cd.high),lo=this.priceToY(cd.low),bl=cd.close>=cd.open,co=bl?getComputedStyle(document.documentElement).getPropertyValue("--gg"):"#d32f2f",w=this.getCandleWidth();this.ctx.strokeStyle=co;this.ctx.lineWidth=Math.max(1,w*.18);this.ctx.beginPath();this.ctx.moveTo(x,hi);this.ctx.lineTo(x,lo);this.ctx.stroke();const bh=Math.max(1,Math.abs(cl-o)),bt=Math.min(o,cl);this.ctx.fillStyle=co;if(lv){this.ctx.shadowColor=co;this.ctx.shadowBlur=7}this.ctx.fillRect(x-w/2,bt,w,bh);if(lv)this.ctx.shadowBlur=0}drawIndicators(){for(const in2 of st.inds){if(in2.type==="bb")this.drawBB(in2);else if(in2.type==="tl")this.drawTL(in2)}}drawHandle(x,y,co="#ffd700"){this.ctx.save();this.ctx.fillStyle=co;this.ctx.strokeStyle="rgba(0,0,0,.45)";this.ctx.lineWidth=2;this.ctx.beginPath();this.ctx.arc(x,y,5.2,0,Math.PI*2);this.ctx.fill();this.ctx.stroke();this.ctx.restore()}drawBB(in2){if(this.cs.length<(in2.period||20))return;const p=in2.period||20,std=in2.std||2;let sm=[],up=[],lw=[];for(let i=p-1;i<this.cs.length;i++){let su=0;for(let j=0;j<p;j++)su+=this.cs[i-j].close;const av=su/p;let va=0;for(let j=0;j<p;j++){const df=this.cs[i-j].close-av;va+=df*df}const sd=Math.sqrt(va/p);sm.push(av);up.push(av+std*sd);lw.push(av-std*sd)}this.ctx.strokeStyle=in2.color||"#ffff00";this.ctx.lineWidth=in2.width||2;this.ctx.beginPath();for(let i=0;i<sm.length;i++){const x=this.indexToX(i+p-1),y=this.priceToY(sm[i]);i===0?this.ctx.moveTo(x,y):this.ctx.lineTo(x,y)}this.ctx.stroke();this.ctx.strokeStyle=in2.color||"#ffff00";this.ctx.globalAlpha=.5;this.ctx.beginPath();for(let i=0;i<up.length;i++){const x=this.indexToX(i+p-1),y=this.priceToY(up[i]);i===0?this.ctx.moveTo(x,y):this.ctx.lineTo(x,y)}this.ctx.stroke();this.ctx.beginPath();for(let i=0;i<lw.length;i++){const x=this.indexToX(i+p-1),y=this.priceToY(lw[i]);i===0?this.ctx.moveTo(x,y):this.ctx.lineTo(x,y)}this.ctx.stroke();this.ctx.globalAlpha=1}drawTL(in2){if(!in2.x1||!in2.y1||!in2.x2||!in2.y2)return;this.ctx.strokeStyle=in2.color||"#ffff00";this.ctx.lineWidth=in2.width||2;this.ctx.beginPath();this.ctx.moveTo(in2.x1,in2.y1);this.ctx.lineTo(in2.x2,in2.y2);this.ctx.stroke();const mx=(in2.x1+in2.x2)/2,my=(in2.y1+in2.y2)/2;this.drawHandle(mx,my,"#ffd700");this.drawHandle(in2.x1,in2.y1,"#ffd700");this.drawHandle(in2.x2,in2.y2,"#ffd700")}draw(){this.tickZoom();this.ctx.clearRect(0,0,this.w,this.h);this.drawGrid();for(let i=0;i<this.cs.length;i++){const x=this.indexToX(i);if(x<-60||x>this.w+60)continue;this.drawCandle(this.cs[i],x,0)}if(this.cc&&(!this.cs.length||this.cc.timestamp!==this.cs[this.cs.length-1].timestamp)){const lX=this.indexToX(this.cs.length);if(lX>=-60&&lX<=this.w+60)this.drawCandle(this.cc,lX,1)}this.drawCurrentPriceLine();this.drawIndicators();this.drawTradeMarkersCanvas()}loop(){if(!this.on)return;this.draw();this.loopFrame=requestAnimationFrame(()=>this.loop())}applyZoomAround(mx,my,sc){const oZ=this.targetZoom,nZ=clp(oZ*sc,this.minZoom,this.maxZoom);if(Math.abs(nZ-oZ)<1e-6)return;const ix=this.xToIndex(mx);this.targetZoom=nZ;this.zoom=nZ;const nx=mx-ix*this.getSpacing();this.targetScrollOffset=nx;this.manualScrollOffset=nx;this.clampPan()}hitHandle(x,y,hx,hy,r=18){return Math.hypot(x-hx,y-hy)<=r}hitTrendDot(x,y){for(const in2 of st.inds){if(in2.type==="tl"){const mx=(in2.x1+in2.x2)/2,my=(in2.y1+in2.y2)/2;if(this.hitHandle(x,y,mx,my,18))return{ind:in2,pt:"mid"};if(this.hitHandle(x,y,in2.x1,in2.y1,18))return{ind:in2,pt:"p1"};if(this.hitHandle(x,y,in2.x2,in2.y2,18))return{ind:in2,pt:"p2"}}}return null}moveTrendDot(x,y){const{ind,pt}=this.tlDrag;if(pt==="mid"){const mx=(ind.x1+ind.x2)/2,my=(ind.y1+ind.y2)/2;const dx=x-mx,dy=y-my;ind.x1+=dx;ind.y1+=dy;ind.x2+=dx;ind.y2+=dy}else if(pt==="p1"){ind.x1=x;ind.y1=y}else if(pt==="p2"){ind.x2=x;ind.y2=y}}ev(){addEventListener("resize",()=>this.setup());this.cv.addEventListener("wheel",e=>{e.preventDefault();const r=this.cv.getBoundingClientRect(),mx=e.clientX-r.left,my=e.clientY-r.top,sc=e.deltaY>0?1/1.10:1.10;this.applyZoomAround(mx,my,sc)},{passive:!1});const dn=(x,y,t)=>{const ht=this.hitTrendDot(x,y);if(ht){this.tlDrag=ht;return}this.drag=1;this.dragStartX=x;this.dragStartScroll=this.targetScrollOffset;this.momentum=0;this.lastDragDelta=0;this.lastDragTime=t;this.lastMoveX=x},mv=(x,y,t)=>{if(this.tlDrag){this.moveTrendDot(x,y);return}if(this.drag){const d=x-this.dragStartX;this.targetScrollOffset=this.dragStartScroll+d;this.clampPan();const dt=t-this.lastDragTime;if(dt>0&&dt<100)this.lastDragDelta=(x-(this.lastMoveX||x))/dt*16;this.lastMoveX=x;this.lastDragTime=t}},up=()=>{this.tlDrag=null;if(this.drag&&Math.abs(this.lastDragDelta)>1)this.momentum=this.lastDragDelta;this.drag=0};this.cv.addEventListener("mousedown",e=>{const r=this.cv.getBoundingClientRect();dn(e.clientX-r.left,e.clientY-r.top,Date.now())});addEventListener("mousemove",e=>{const r=this.cv.getBoundingClientRect();mv(e.clientX-r.left,e.clientY-r.top,Date.now())});addEventListener("mouseup",up);const ds=(a,b)=>Math.hypot(b.clientX-a.clientX,b.clientY-a.clientY);this.cv.addEventListener("touchstart",e=>{const r=this.cv.getBoundingClientRect();if(e.touches.length===1){const T=e.touches[0];dn(T.clientX-r.left,T.clientY-r.top,Date.now())}else if(e.touches.length===2){this.drag=0;this.pinch=1;this.p0=ds(e.touches[0],e.touches[1]);this.pMidX=((e.touches[0].clientX+e.touches[1].clientX)/2)-r.left;this.pMidY=((e.touches[0].clientY+e.touches[1].clientY)/2)-r.top}},{passive:!1});this.cv.addEventListener("touchmove",e=>{e.preventDefault();const r=this.cv.getBoundingClientRect();if(this.pinch&&e.touches.length===2){const d=ds(e.touches[0],e.touches[1]);if(this.p0>0){const sc=clp(d/(this.p0||d),.2,5);this.applyZoomAround(this.pMidX,this.pMidY,sc)}this.p0=d}else if(!this.pinch&&e.touches.length===1){const T=e.touches[0];mv(T.clientX-r.left,T.clientY-r.top,Date.now())}},{passive:!1});this.cv.addEventListener("touchend",e=>{if(e.touches.length<2){this.pinch=0;this.p0=0}if(e.touches.length===0)up()},{passive:!1});this.cv.addEventListener("touchcancel",()=>{this.pinch=0;this.p0=0;up()},{passive:!1})}async boot(){$("sk").classList.add("on");sID=sessionStorage.getItem("sessID")||uid();sessionStorage.setItem("sessID",sID);await this.setPair("EUR/USD");const fb=await ldFB("EUR/USD");this.cs=fb.length>0?[...fb]:[];if(this.cs.length>0){this.t0=this.cs[this.cs.length-1].timestamp+this.tf;this.cp=this.cs[this.cs.length-1].close}else{this.iCL(100)}this.snapToLive();this.updatePriceRange();await this.chkMR();this.subLV();this.stMC();ldTr();this.on=1;this.tick();this.loop();$("sk").classList.remove("on");window.addEventListener("beforeunload",async()=>{if(isMgr)await clMgr(this.pair)})}}const chart=new Chart;window.chart=chart;await chart.boot();const dt=$("datetime"),upDT=()=>{const n=new Date,h=String(n.getHours()).padStart(2,"0"),m=String(n.getMinutes()).padStart(2,"0"),s=String(n.getSeconds()).padStart(2,"0");dt.textContent=`${h}:${m}:${s}`};setInterval(upDT,1000);upDT();const tI=$("timeInput"),tPP=$("timePickerPopup"),mB=$("manualBtn");let iMM=!1;tI.onclick=e=>{if(iMM)return;e.stopPropagation();tPP.classList.toggle("show")};document.addEventListener("click",e=>{if(!e.target.closest("#timeWrapper"))tPP.classList.remove("show")});document.querySelectorAll(".timeBtn").forEach(bn=>bn.onclick=e=>{e.stopPropagation();tI.value=bn.getAttribute("data-time");tPP.classList.remove("show")});mB.onclick=e=>{e.stopPropagation();iMM=!iMM;if(iMM){tPP.classList.remove("show");tI.readOnly=!1;tI.focus();tI.select()}else tI.readOnly=!0};tI.onblur=()=>{if(iMM){const vl=tI.value;if(!/^\d{2}:\d{2}:\d{2}$/.test(vl))tI.value="00:01:00";iMM=!1;tI.readOnly=!0}};let amt=1;const aI=$("amountInput"),upd=()=>{let s=String(aI.value).replace(/,|\$|\s/g,"").trim();if(!s){amt=1;aI.value="$ 1";return}let v=parseFloat(s);if(!isFinite(v))v=1;v=Math.max(1,Math.min(999999,v));amt=v;aI.value="$ "+v};$("plus").onclick=()=>{amt++;aI.value="$ "+amt};$("minus").onclick=()=>{amt=Math.max(1,amt-1);aI.value="$ "+amt};aI.oninput=upd;aI.onblur=upd;upd();const opT=async tp=>{if(!chart.cc)return;const dr=pD(tI.value),op=+chart.cc.close,ci=chart.cs.length;const tr={id:uid(),type:tp,amount:amt,openPrice:op,openTime:Date.now(),duration:dr,candleIndex:ci,pair:chart.pair,profit:0,closed:0,priceHistory:[op]};st.trades.push(tr);svTr();rTP()};$("buy").onclick=()=>opT("buy");$("sell").onclick=()=>opT("sell");$("indBtn1").onclick=()=>{$("tradesPanel").classList.toggle("open");rTP()};$("closeTrPanel").onclick=()=>$("tradesPanel").classList.remove("open");$("tradesContent").onclick=e=>{const cd=e.target.closest(".tradeCard");if(!cd)return;const idx=+cd.dataset.idx;const dt=$("trD"+idx);if(dt){dt.classList.toggle("open")}};$("indBtn2").onclick=()=>{$("indicatorsPanel").classList.toggle("show")};$("closeIndBtn").onclick=()=>$("indicatorsPanel").classList.remove("show");$("eyeBtn").onclick=()=>{shIN=!shIN;rIN()};const pt=$("platTime"),tPl=()=>{const d=new Date(Date.now()+3*36e5);pt.textContent=`UTC+3 ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`};setInterval(tPl,250);tPl();upPF("EUR/USD",$("pairFlags"));rPP();rTP();$("pairHud").onclick=e=>{e.stopPropagation();$("pairPanel").classList.toggle("on");rPP()};$("pairClose").onclick=()=>$("pairPanel").classList.remove("on");$("pairList").onclick=async e=>{const b=e.target.closest("button.pit");if(!b)return;const p=b.getAttribute("data-p");if(e.target&&e.target.getAttribute&&e.target.getAttribute("data-s")){st.fav.has(p)?st.fav.delete(p):st.fav.add(p);rPP();return}$("pairPanel").classList.remove("on");await chart.switchPair(p)};document.addEventListener("click",e=>{$("pairPanel").classList.contains("on")&&!e.target.closest("#pairPanel")&&!e.target.closest("#pairHud")&&$("pairPanel").classList.remove("on")});const iN={aco:"Accelerator Oscillator",adx:"ADX",alligator:"Alligator",aroon:"Aroon",atr:"ATR",awesome:"Awesome Oscillator",bearpower:"Bears Power",bb:"Bollinger Bands",bbw:"Bollinger Bands Width",bullpower:"Bulls Power",cci:"CCI",donchian:"Donchian Channel",demarker:"DeMarker",envelopes:"Envelopes",fractal:"Fractal",fcb:"Fractal Chaos Bands",ichimoku:"Ichimoku",keltner:"Keltner Channel",macd:"MACD",momentum:"Momentum",ma:"Moving Average",mao:"Moving Average Oscillator",psar:"Parabolic SAR",rsi:"RSI",roc:"ROC",schaff:"Schaff Trend Cycle",stochastic:"Stochastic",supertrend:"SuperTrend",volume:"Volume",vortex:"Vortex",williamsr:"Williams %R",zigzag:"ZigZag",tl:"Trendline"};function rIB(){const br=$("indBar");br.innerHTML=(st.inds||[]).map((in2,i)=>`<div class="indBadge"><span class="name" data-i="${i}">${iN[in2.type]||in2.type}</span><button data-rm="${i}">√ó</button></div>`).join("");br.querySelectorAll("[data-rm]").forEach(bn=>bn.onclick=()=>{st.inds.splice(+bn.dataset.rm,1);rIB();rIN()});br.querySelectorAll("[data-i]").forEach(sp=>sp.onclick=()=>{eI=st.inds[+sp.dataset.i];oIS(eI)});br.style.display=st.inds&&st.inds.length?"flex":"none";rIN()}let eI=null;function oIS(in2){$("indSetTitle").textContent=iN[in2.type]||in2.type;$("indColor").value=in2.color||"#ffff00";$("indWidth").value=in2.width||2;const pR=$("periodRow"),sR=$("stdRow");pR.style.display="none";sR.style.display="none";if(in2.type==="bb"){pR.style.display="flex";sR.style.display="flex";$("indPeriod").value=in2.period||20;$("indStd").value=in2.std||2}$("indSet").classList.add("show")}$("indSetClose").onclick=()=>$("indSet").classList.remove("show");$("indRemove").onclick=()=>{if(!eI)return;const ix=st.inds.indexOf(eI);if(ix>=0){st.inds.splice(ix,1);rIB();rIN()}$("indSet").classList.remove("show");eI=null};$("indColor").oninput=()=>{if(eI){eI.color=$("indColor").value}};$("indWidth").oninput=()=>{if(eI){eI.width=+$("indWidth").value}};$("indPeriod").oninput=()=>{if(eI){eI.period=+$("indPeriod").value}};$("indStd").oninput=()=>{if(eI){eI.std=+$("indStd").value}};$("indicatorsPanel").onclick=e=>{const it=e.target.closest(".indItem");if(!it)return;const t=it.dataset.ind;if(t==="bb"){st.inds.push({id:uid(),type:"bb",color:"#ffff00",width:2,period:20,std:2});rIB();$("indicatorsPanel").classList.remove("show")}else if(t==="tl"){const x1=chart.w*.3,y1=chart.h*.3,x2=chart.w*.7,y2=chart.h*.7;st.inds.push({id:uid(),type:"tl",color:"#ffff00",width:2,x1,y1,x2,y2});rIB();$("indicatorsPanel").classList.remove("show")}else{shSt("ÿßŸÑŸÖÿ§ÿ¥ÿ± "+iN[t]+" ŸÇÿ±Ÿäÿ®ÿßŸã","success");$("indicatorsPanel").classList.remove("show")}};rIB();rIN();</script></body></html>
